<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Counter System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; }
        .source-btn { transition: all 0.3s ease; }
        .source-btn:hover { transform: scale(1.05); }
        #videoFeed { max-width: 100%; height: auto; }
        #activityTable { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Person Counter System</h1>

    <div id="sourceSelection" class="w-full max-w-2xl mx-auto">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Select Video Source</h2>
        <div class="grid grid-cols-1 gap-4">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-medium text-gray-800">Available Sources:</h3>
                <ul class="list-disc list-inside text-gray-600 mt-2">
                    <li>üìÅ Sample Video - Local MP4 file</li>
                    <li>üìπ IP Camera - Network RTSP camera</li>
                    <li>üì± Android Phone - Mobile camera</li>
                </ul>
            </div>
            <div class="flex flex-col space-y-3">
                <button onclick="showSampleVideoForm()" class="source-btn bg-blue-500 text-white px-4 py-2 rounded-lg text-center hover:bg-blue-600">üìÅ Sample Video (MP4)</button>
                <button onclick="showLoginForm('camera')" class="source-btn bg-green-500 text-white px-4 py-2 rounded-lg text-center hover:bg-green-600">üìπ IP Camera Feed</button>
                <button onclick="showLoginForm('android')" class="source-btn bg-purple-500 text-white px-4 py-2 rounded-lg text-center hover:bg-purple-600">üì± Android Phone Camera</button>
            </div>
        </div>
    </div>

    <div id="sampleVideoForm" class="hidden w-full max-w-md mt-6 bg-white p-6 rounded-lg shadow-md mx-auto">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Sample Video Options</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-600">Choose an option:</label>
                <button onclick="usePreUploadedVideo()" class="bg-blue-500 text-white px-4 py-2 rounded-lg w-full hover:bg-blue-600 mt-2">Use Pre-Uploaded Sample Video</button>
            </div>
            <div>
                <label for="videoUpload" class="block text-gray-600">Upload a new video (MP4):</label>
                <input type="file" id="videoUpload" accept="video/mp4" class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex space-x-3">
                <button onclick="uploadVideo()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Upload and Process</button>
                <button onclick="cancelSampleVideo()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loginForm" class="hidden w-full max-w-md mt-6 bg-white p-6 rounded-lg shadow-md mx-auto">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Enter Camera Details</h2>
        <div class="space-y-4">
            <div>
                <label for="cameraUrl" class="block text-gray-600">Camera URL</label>
                <input type="text" id="cameraUrl" class="w-full p-2 border rounded-lg" placeholder="e.g., rtsp://username:password@host:port/path or http://host:port/videofeed">
            </div>
            <div class="flex space-x-3">
                <button onclick="submitCameraUrl()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Connect</button>
                <button onclick="cancelLogin()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <div id="videoContainer" class="hidden w-full max-w-4xl mt-6 mx-auto">
        <a href="/" class="text-blue-500 hover:underline mb-4 inline-block">‚Üê Back to Selection</a>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Processing Video...</h2>
            <div>
                <img id="videoFeed" src="" alt="Video Feed" class="w-full rounded-lg">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-lg font-medium text-gray-800">Current:</h3>
                <p id="currentCount" class="text-2xl font-bold text-blue-500">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-lg font-medium text-gray-800">Max:</h3>
                <p id="maxCount" class="text-2xl font-bold text-red-500">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-lg font-medium text-gray-800">Source:</h3>
                <p id="sourceType" class="text-2xl font-bold text-yellow-500">-</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md mt-4">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Recent Activity</h3>
            <div id="activityTable" class="overflow-x-auto">
                <table class="w-full text-left text-gray-600">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2">Timestamp</th>
                            <th class="p-2">Person Count</th>
                            <th class="p-2">Change Type</th>
                            <th class="p-2">Max Count</th>
                            <th class="p-2">Source</th>
                        </tr>
                    </thead>
                    <tbody id="activityBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentSource = '';
        let dataPollingInterval = null;

        function showSampleVideoForm() {
            stopDataPolling();
            document.getElementById('sourceSelection').classList.add('hidden');
            document.getElementById('sampleVideoForm').classList.remove('hidden');
            document.getElementById('videoContainer').classList.add('hidden');
        }

        function usePreUploadedVideo() {
            document.getElementById('sampleVideoForm').classList.add('hidden');
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('videoFeed').src = '/video_feed/sample';
            startDataPolling('file');
        }

        function uploadVideo() {
            const videoFile = document.getElementById('videoUpload').files[0];
            if (!videoFile) {
                alert('Please select a video file to upload');
                return;
            }
            const formData = new FormData();
            formData.append('video', videoFile);
            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.video_path) {
                    document.getElementById('sampleVideoForm').classList.add('hidden');
                    document.getElementById('videoContainer').classList.remove('hidden');
                    document.getElementById('videoFeed').src = `/video_feed/sample?video_path=${encodeURIComponent(data.video_path)}`;
                    startDataPolling('file');
                } else {
                    alert('Error uploading video: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error uploading video:', error);
                alert('Error uploading video');
            });
        }

        function cancelSampleVideo() {
            document.getElementById('sampleVideoForm').classList.add('hidden');
            document.getElementById('sourceSelection').classList.remove('hidden');
            stopDataPolling();
        }

        function showLoginForm(source) {
            currentSource = source;
            stopDataPolling();
            document.getElementById('sourceSelection').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('cameraUrl').value = '';
        }

        function submitCameraUrl() {
            const url = document.getElementById('cameraUrl').value;
            if (url) {
                const encodedUrl = encodeURIComponent(url);
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('videoContainer').classList.remove('hidden');
                document.getElementById('videoFeed').src = `/video_feed/${currentSource}?${currentSource}_url=${encodedUrl}`;
                startDataPolling(currentSource);
            } else {
                alert('Please enter a valid camera URL');
            }
        }

        function cancelLogin() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('sourceSelection').classList.remove('hidden');
            stopDataPolling();
        }

        // Start polling for data updates
        function startDataPolling(sourceType) {
            if (dataPollingInterval) {
                clearInterval(dataPollingInterval);
            }
            document.getElementById('sourceType').textContent = sourceType.toUpperCase();
            updateData();
            dataPollingInterval = setInterval(updateData, 500);
        }

        // Stop polling for data updates
        function stopDataPolling() {
            if (dataPollingInterval) {
                clearInterval(dataPollingInterval);
                dataPollingInterval = null;
            }
            document.getElementById('currentCount').textContent = '-';
            document.getElementById('maxCount').textContent = '-';
            document.getElementById('sourceType').textContent = '-';
            document.getElementById('activityBody').innerHTML = '';
        }

        // Update video feed source and show interface
        const videoFeed = document.getElementById('videoFeed');
        const sourceSelection = document.getElementById('sourceSelection');
        const videoContainer = document.getElementById('videoContainer');
        if (window.location.pathname.startsWith('/video_feed')) {
            sourceSelection.classList.add('hidden');
            videoContainer.classList.remove('hidden');
            videoFeed.src = window.location.pathname + window.location.search;
            const sourceType = window.location.pathname.includes('sample') ? 'file' : 
                              window.location.pathname.includes('camera') ? 'rtsp' : 'android';
            startDataPolling(sourceType);
        }

        // Fetch and update data
        function updateData() {
            fetch('/get_data', { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        const latest = data[data.length - 1];
                        document.getElementById('currentCount').textContent = latest.person_count || 0;
                        document.getElementById('maxCount').textContent = latest.max_count || 0;
                        document.getElementById('sourceType').textContent = (latest.source || 'unknown').toUpperCase();
                        document.getElementById('activityBody').innerHTML = '';
                        data.slice(-5).reverse().forEach(entry => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="p-2">${entry.timestamp}</td>
                                <td class="p-2">${entry.person_count}</td>
                                <td class="p-2">${entry.change_type}</td>
                                <td class="p-2">${entry.max_count}</td>
                                <td class="p-2">${(entry.source || 'unknown').toUpperCase()}</td>
                            `;
                            document.getElementById('activityBody').appendChild(row);
                        });
                    } else {
                        document.getElementById('currentCount').textContent = 0;
                        document.getElementById('maxCount').textContent = 0;
                        document.getElementById('sourceType').textContent = '-';
                        document.getElementById('activityBody').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('currentCount').textContent = 'Error';
                    document.getElementById('maxCount').textContent = 'Error';
                    document.getElementById('sourceType').textContent = 'Error';
                    document.getElementById('activityBody').innerHTML = '';
                });
        }

        // Stop polling when navigating away
        window.addEventListener('beforeunload', stopDataPolling);
    </script>
</body>
</html>